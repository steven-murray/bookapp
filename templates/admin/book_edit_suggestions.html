{% extends "base.html" %}

{% block title %}Book Edit Suggestions - Book Tracker{% endblock %}

{% block content %}
<h1>Book Edit Suggestions</h1>

<div class="tabs">
    <button class="tab-btn active" onclick="switchTab('pending')">Pending ({{ pending|length }})</button>
    <button class="tab-btn" onclick="switchTab('reviewed')">Reviewed</button>
</div>

<!-- Pending Suggestions Tab -->
<div id="pending-tab" class="tab-content active">
    {% if pending %}
        {% for suggestion in pending %}
            <div class="suggestion-card">
                <div class="suggestion-header">
                    <h3>{{ suggestion.book.title }}</h3>
                    <span class="badge">Suggested by {{ suggestion.student.first_name }} {{ suggestion.student.last_name }}</span>
                    <span class="text-muted">{{ suggestion.suggested_at.strftime('%Y-%m-%d %H:%M') }}</span>
                </div>
                
                <div class="suggestion-body">
                    <p><strong>Reason:</strong> {{ suggestion.reason or 'No reason provided' }}</p>
                    
                    <h4>Suggested Changes:</h4>
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th>Field</th>
                                <th>Current Value</th>
                                <th>Suggested Value</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if suggestion.suggested_title %}
                                <tr>
                                    <td><strong>Title</strong></td>
                                    <td>{{ suggestion.book.title }}</td>
                                    <td class="suggested-value">{{ suggestion.suggested_title }}</td>
                                </tr>
                            {% endif %}
                            {% if suggestion.suggested_author %}
                                <tr>
                                    <td><strong>Author</strong></td>
                                    <td>{{ suggestion.book.author or 'N/A' }}</td>
                                    <td class="suggested-value">{{ suggestion.suggested_author }}</td>
                                </tr>
                            {% endif %}
                            {% if suggestion.suggested_openlibrary_id %}
                                <tr>
                                    <td><strong>OpenLibrary ID</strong></td>
                                    <td>{{ suggestion.book.openlibrary_id or 'N/A' }}</td>
                                    <td class="suggested-value">{{ suggestion.suggested_openlibrary_id }}</td>
                                </tr>
                            {% endif %}
                            {% if suggestion.suggested_publication_year %}
                                <tr>
                                    <td><strong>Publication Year</strong></td>
                                    <td>{{ suggestion.book.publication_year or 'N/A' }}</td>
                                    <td class="suggested-value">{{ suggestion.suggested_publication_year }}</td>
                                </tr>
                            {% endif %}
                            {% if suggestion.suggested_book_type %}
                                <tr>
                                    <td><strong>Type</strong></td>
                                    <td>{{ suggestion.book.book_type or 'N/A' }}</td>
                                    <td class="suggested-value">{{ suggestion.suggested_book_type }}</td>
                                </tr>
                            {% endif %}
                            {% if suggestion.suggested_genre %}
                                <tr>
                                    <td><strong>Genre</strong></td>
                                    <td>{{ suggestion.book.genre or 'N/A' }}</td>
                                    <td class="suggested-value">{{ suggestion.suggested_genre }}</td>
                                </tr>
                            {% endif %}
                            {% if suggestion.suggested_sub_genre %}
                                <tr>
                                    <td><strong>Sub-genre</strong></td>
                                    <td>{{ suggestion.book.sub_genre or 'N/A' }}</td>
                                    <td class="suggested-value">{{ suggestion.suggested_sub_genre }}</td>
                                </tr>
                            {% endif %}
                            {% if suggestion.suggested_topic %}
                                <tr>
                                    <td><strong>Topic</strong></td>
                                    <td>{{ suggestion.book.topic or 'N/A' }}</td>
                                    <td class="suggested-value">{{ suggestion.suggested_topic }}</td>
                                </tr>
                            {% endif %}
                            {% if suggestion.suggested_lexile_rating %}
                                <tr>
                                    <td><strong>Lexile Rating</strong></td>
                                    <td>{{ suggestion.book.lexile_rating or 'N/A' }}</td>
                                    <td class="suggested-value">{{ suggestion.suggested_lexile_rating }}</td>
                                </tr>
                            {% endif %}
                            {% if suggestion.suggested_grade %}
                                <tr>
                                    <td><strong>Grade</strong></td>
                                    <td>{{ suggestion.book.grade or 'N/A' }}</td>
                                    <td class="suggested-value">{{ suggestion.suggested_grade }}</td>
                                </tr>
                            {% endif %}
                            {% if suggestion.suggested_description %}
                                <tr>
                                    <td><strong>Description</strong></td>
                                    <td>{{ (suggestion.book.description[:100] + '...') if suggestion.book.description and suggestion.book.description|length > 100 else (suggestion.book.description or 'N/A') }}</td>
                                    <td class="suggested-value">{{ (suggestion.suggested_description[:100] + '...') if suggestion.suggested_description|length > 100 else suggestion.suggested_description }}</td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
                
                <div class="suggestion-actions">
                    <form method="POST" action="{{ url_for('review_book_edit_suggestion', suggestion_id=suggestion.id) }}" style="display:inline;">
                        <input type="hidden" name="action" value="approve">
                        <div class="form-group" style="display:inline-block; margin-right: 10px;">
                            <input type="text" name="admin_notes" placeholder="Optional notes" class="form-control" style="width: 300px; display:inline;">
                        </div>
                        <button type="submit" class="btn btn-success" onclick="return confirm('Apply these changes to the book?')">✓ Approve & Apply</button>
                    </form>
                    
                    <form method="POST" action="{{ url_for('review_book_edit_suggestion', suggestion_id=suggestion.id) }}" style="display:inline;">
                        <input type="hidden" name="action" value="reject">
                        <button type="submit" class="btn btn-danger" onclick="return confirm('Reject this suggestion?')">✗ Reject</button>
                    </form>
                    
                    <a href="{{ url_for('edit_book', book_id=suggestion.book.id) }}" class="btn btn-secondary">Edit Book Manually</a>
                </div>
            </div>
        {% endfor %}
    {% else %}
        <div class="empty-state">
            <p>No pending edit suggestions.</p>
        </div>
    {% endif %}
</div>

<!-- Reviewed Suggestions Tab -->
<div id="reviewed-tab" class="tab-content">
    {% if reviewed %}
        <table class="data-table">
            <thead>
                <tr>
                    <th>Book</th>
                    <th>Student</th>
                    <th>Status</th>
                    <th>Reviewed By</th>
                    <th>Date</th>
                    <th>Notes</th>
                </tr>
            </thead>
            <tbody>
                {% for suggestion in reviewed %}
                    <tr>
                        <td>{{ suggestion.book.title }}</td>
                        <td>{{ suggestion.student.first_name }} {{ suggestion.student.last_name }}</td>
                        <td>
                            <span class="badge {% if suggestion.status == 'approved' %}badge-success{% else %}badge-danger{% endif %}">
                                {{ suggestion.status.title() }}
                            </span>
                        </td>
                        <td>{{ suggestion.reviewed_by.username if suggestion.reviewed_by else 'N/A' }}</td>
                        <td>{{ suggestion.reviewed_at.strftime('%Y-%m-%d') if suggestion.reviewed_at else 'N/A' }}</td>
                        <td>{{ suggestion.admin_notes or '—' }}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <div class="empty-state">
            <p>No reviewed suggestions yet.</p>
        </div>
    {% endif %}
</div>

<script>
function switchTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected tab
    document.getElementById(tabName + '-tab').classList.add('active');
    event.target.classList.add('active');
}
</script>

<style>
.suggestion-card {
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    background: white;
}

.suggestion-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 15px;
    border-bottom: 1px solid var(--border-color);
}

.suggestion-header h3 {
    margin: 0;
}

.suggestion-body {
    margin-bottom: 20px;
}

.comparison-table {
    width: 100%;
    margin-top: 10px;
    border-collapse: collapse;
}

.comparison-table th,
.comparison-table td {
    padding: 10px;
    border: 1px solid var(--border-color);
    text-align: left;
}

.comparison-table th {
    background-color: var(--light-gray);
    font-weight: bold;
}

.suggested-value {
    background-color: #ffffcc;
    font-weight: bold;
}

.suggestion-actions {
    display: flex;
    gap: 10px;
    align-items: center;
}

.badge-success {
    background-color: #28a745;
    color: white;
}

.badge-danger {
    background-color: #dc3545;
    color: white;
}
</style>
{% endblock %}
