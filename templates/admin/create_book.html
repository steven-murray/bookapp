{% extends "base.html" %}

{% block title %}Add Book - Book Tracker{% endblock %}

{% block content %}
<h1>Add Book Manually</h1>

<div class="form-container">
    <form method="POST" action="{{ url_for('create_book') }}">
        {{ form.hidden_tag() }}
        
        <div class="form-group">
            {{ form.title.label }}
            {{ form.title(class="form-control", id="title") }}
            {% if form.title.errors %}
                <div class="error">
                    {% for error in form.title.errors %}
                        <p>{{ error }}</p>
                    {% endfor %}
                </div>
            {% endif %}
        </div>
        
        <div class="form-group">
            {{ form.author.label }}
            {{ form.author(class="form-control", id="author") }}
        </div>

        <div class="form-group">
            {{ form.openlibrary_id.label }}
            <div style="display: flex; gap: 10px; align-items: center;">
                {{ form.openlibrary_id(class="form-control", id="openlibrary_id", placeholder="/works/OL45804W or OL45804W", style="flex: 1;") }}
                <button type="button" id="fetchMetadataBtn" class="btn btn-secondary" onclick="fetchOpenLibraryMetadata()" title="Fetch metadata from OpenLibrary">
                    ðŸ”„ Fetch
                </button>
            </div>
            <small class="form-text text-muted">Enter the OpenLibrary work ID (e.g., /works/OL45804W or just OL45804W)</small>
        </div>
        
        <div class="form-actions" style="margin: 0.5rem 0 1rem;">
            <button type="button" class="btn btn-secondary" id="btn-enrich-ol">Guess from OpenLibrary</button>
            <small id="enrich-status" class="form-text" style="margin-left: 0.5rem;"></small>
        </div>

        <div class="form-group">
            {{ form.publication_year.label }}
            {{ form.publication_year(class="form-control", id="publication_year", placeholder="e.g., 2020") }}
        </div>
        
        <div class="form-row">
            <div class="form-group">
                {{ form.book_type.label }}
                {{ form.book_type(class="form-control", id="book_type") }}
            </div>
            <div class="form-group">
                {{ form.genre.label }}
                {{ form.genre(class="form-control", id="genre") }}
            </div>
            
            <div class="form-group">
                {{ form.topic.label }}
                {{ form.topic(class="form-control", id="topic") }}
            </div>
        </div>

        <div class="form-group">
            {{ form.sub_genre.label }}
            {{ form.sub_genre(class="form-control", id="sub_genre") }}
        </div>
        
        <div class="form-group">
            {{ form.lexile_rating.label }}
            {{ form.lexile_rating(class="form-control", placeholder="e.g., 750L", id="lexile_rating") }}
        </div>
        
        <div class="form-group">
            {{ form.grade.label }}
            {{ form.grade(class="form-control", placeholder="1-12", id="grade") }}
            <small class="form-text">Optional. Intended grade level (1-12).</small>
        </div>
        
        <div class="form-group">
            {{ form.owned.label }}
            {{ form.owned(class="form-control") }}
            <small class="form-text">Ownership status. Defaults to "Not Owned".</small>
        </div>
        
        <div class="form-group">
            {{ form.description.label }}
            {{ form.description(class="form-control", rows="4", id="description") }}
        </div>
        
        <div class="form-actions">
            <button type="submit" class="btn btn-primary">Add Book</button>
            <a href="{{ url_for('admin_books') }}" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>

<script>
// Fetch metadata from OpenLibrary
function fetchOpenLibraryMetadata() {
    const olidInput = document.getElementById('openlibrary_id');
    const olid = olidInput.value.trim();
    
    if (!olid) {
        alert('Please enter an OpenLibrary ID first');
        return;
    }
    
    const btn = document.getElementById('fetchMetadataBtn');
    btn.disabled = true;
    btn.textContent = 'â³ Fetching...';
    
    fetch('/api/fetch-openlibrary-metadata', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ openlibrary_id: olid })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            // Populate form fields with fetched data
            if (data.title) document.getElementById('title').value = data.title;
            if (data.author) document.getElementById('author').value = data.author;
            if (data.description) document.getElementById('description').value = data.description;
            if (data.publication_year) document.getElementById('publication_year').value = data.publication_year;
            if (data.topic) document.getElementById('topic').value = data.topic;
            if (data.lexile_rating) document.getElementById('lexile_rating').value = data.lexile_rating;
            if (data.grade) document.getElementById('grade').value = data.grade;
            
            // Handle book_type, genre, and sub_genre with proper sequencing
            if (data.book_type) {
                document.getElementById('book_type').value = data.book_type;
                
                // If we have genre data, update the genre dropdown first
                if (data.genre) {
                    updateGenreDropdown(data.book_type, data.genre);
                    
                    // If we have sub-genre data, wait for genre dropdown to update, then update sub-genre
                    if (data.sub_genre) {
                        setTimeout(() => {
                            updateSubGenreDropdown(data.book_type, data.genre, data.sub_genre);
                        }, 200);
                    }
                }
            }
            
            alert('Metadata fetched successfully! Review the updated fields.');
        }
    })
    .catch(error => {
        alert('Error fetching metadata: ' + error);
    })
    .finally(() => {
        btn.disabled = false;
        btn.textContent = 'ðŸ”„ Fetch';
    });
}

// Genre/Sub-genre update functions (global scope so fetchOpenLibraryMetadata can use them)
function updateGenreDropdown(bookType, selectedValue = '') {
    const genreSelect = document.getElementById('genre');
    const subGenreSelect = document.getElementById('sub_genre');
    
    if (!bookType) {
        genreSelect.innerHTML = '<option value="">Select Genre</option>';
        subGenreSelect.innerHTML = '<option value="">Select Sub-genre</option>';
        return;
    }
    
    fetch(`/api/genres/${bookType}`)
        .then(response => response.json())
        .then(genres => {
            genreSelect.innerHTML = '<option value="">Select Genre</option>';
            genres.forEach(genre => {
                const option = document.createElement('option');
                option.value = genre.name;
                option.textContent = genre.name;
                if (genre.name === selectedValue) {
                    option.selected = true;
                }
                genreSelect.appendChild(option);
            });
        });
}

function updateSubGenreDropdown(bookType, genreName, selectedValue = '') {
    const subGenreSelect = document.getElementById('sub_genre');
    
    if (!bookType || !genreName) {
        subGenreSelect.innerHTML = '<option value="">Select Sub-genre</option>';
        return;
    }
    
    fetch(`/api/subgenres-by-name/${bookType}/${encodeURIComponent(genreName)}`)
        .then(response => response.json())
        .then(subgenres => {
            subGenreSelect.innerHTML = '<option value="">Select Sub-genre</option>';
            subgenres.forEach(subgenre => {
                const option = document.createElement('option');
                option.value = subgenre.name;
                option.textContent = subgenre.name;
                if (subgenre.name === selectedValue) {
                    option.selected = true;
                }
                subGenreSelect.appendChild(option);
            });
        });
}

// Dynamic dropdown handling for genre and sub-genre
document.addEventListener('DOMContentLoaded', function() {
    const bookTypeSelect = document.getElementById('book_type');
    const genreSelect = document.getElementById('genre');
    const subGenreSelect = document.getElementById('sub_genre');
    
    // Update genres when book type changes
    bookTypeSelect.addEventListener('change', function() {
        const bookType = this.value;
        updateGenreDropdown(bookType);
    });
    
    // Update sub-genres when genre changes
    genreSelect.addEventListener('change', function() {
        const bookType = bookTypeSelect.value;
        const genreName = this.value;
        updateSubGenreDropdown(bookType, genreName);
    });
});
</script>
{% endblock %}
